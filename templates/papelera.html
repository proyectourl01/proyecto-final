{% extends "encabezado.html" %}

{% block contenido %}
<h1 class="mt-5">Papelera de Reciclaje üóëÔ∏è (Agrupada)</h1>
<p class="lead">Elementos eliminados agrupados por A√±o y Mes. Ser√°n borrados definitivamente despu√©s de 30 d√≠as.</p>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if papelera_jerarquica %}
<div class="accordion" id="papeleraAccordion">
    
    {% for anio, anio_data in papelera_jerarquica.items() %}
    {% set anio_id = "collapse-" + anio %}
    {% set total_elementos = anio_data.Total_Eliminados %}
    
    <div class="accordion-item mb-3 shadow-sm">
        <h2 class="accordion-header" id="heading-{{ anio }}">
            <div class="d-flex w-100 bg-light p-2 align-items-center justify-content-between">
                
                <button class="btn btn-link text-start text-primary fw-bold flex-grow-1 p-2" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#{{ anio_id }}" 
                        aria-expanded="false" 
                        aria-controls="{{ anio_id }}">
                    A√ëO: {{ anio }} (Total de Elementos: {{ total_elementos }})
                    <span class="ms-3 badge bg-secondary">Desplegar/Ocultar Meses</span>
                </button>
                
                <form method="POST" action="{{ url_for('recuperar', tipo='anio', clave=anio) }}" class="d-inline ms-3"
                      onsubmit="return confirm('ADVERTENCIA: ¬øRecuperar TODO el a√±o {{ anio }}? Esto restaurar√° TODOS los meses y registros susceptibles enviados a la papelera.');">
                    <button type="submit" class="btn btn-sm btn-success">Recuperar A√±o</button>
                </form>
            </div>
            </h2>
        
        <div id="{{ anio_id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ anio }}" data-bs-parent="#papeleraAccordion">
            <div class="accordion-body p-0">
                
                {% for mes, mes_data in anio_data.Meses.items() %}
                {% set mes_collapse_id = anio_id + "-mes-" + loop.index|string %}
                {% set total_registros = mes_data.Registros|length %}
                {% set metadato = mes_data.Metadato %}
                
                {% set fecha_caducidad_mes = "" %}
                {% if metadato %}
                    {% set fecha_caducidad_mes = metadato.fecha_caducidad %}
                {% elif total_registros > 0 %}
                    {% set fecha_caducidad_mes = (mes_data.Registros|first).fecha_caducidad %} 
                {% endif %}

                {% set mes_clase = 'bg-info-subtle' if total_registros > 0 else 'bg-warning-subtle' %}

                <div class="card card-body p-3 mb-1 {{ mes_clase }} border-primary-subtle border-start-0 border-end-0 border-top-0 border-bottom-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <strong class="text-secondary">{{ mes }}</strong>
                            {% if metadato %}
                                <span class="badge bg-danger ms-2">Per√≠odo Eliminado</span>
                            {% endif %}
                            <small class="ms-3 text-muted">Registros: {{ total_registros }}</small>
                            
                            {% if fecha_caducidad_mes %}
                                {% set is_expired = fecha_caducidad_mes <= fecha_actual_str %}
                                <strong class="ms-3 text-danger">Caduca: {{ fecha_caducidad_mes }}</strong>
                                {% if is_expired %}
                                    <span class="badge bg-warning text-dark ms-2">PENDIENTE LIMPIEZA</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <div class="btn-group">
                            {% if total_registros > 0 %}
                            <button class="btn btn-sm btn-outline-secondary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#{{ mes_collapse_id }}" aria-expanded="false">
                                Mostrar/Ocultar Registros
                            </button>
                            {% endif %}

                            {% if metadato or total_registros > 0 %}
                            <form method="POST" action="{{ url_for('recuperar', tipo='periodo', clave=anio + mes) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-primary">Recuperar Mes</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if total_registros > 0 %}
                    <div class="collapse mt-3" id="{{ mes_collapse_id }}">
                        <strong class="text-secondary mb-2 d-block">Registros Individuales Eliminados:</strong>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="bg-white">
                                    <th>Registro</th>
                                    <th>Fecha de Eliminaci√≥n</th>
                                    <th>Acci√≥n</th>
                                </thead>
                                <tbody>
                                    {% for registro in mes_data.Registros %}
                                    <tr>
                                        <td>{{ registro.nombre }}</td>
                                        <td>{{ registro.fecha_eliminacion }}</td>
                                        <td>
                                            <form method="POST" action="{{ url_for('recuperar', tipo=registro.tipo, clave=registro.id_clave) }}" class="d-inline">
                                                <button type="submit" class="btn btn-xs btn-success">Recuperar Individual</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                </div>
        </div>
    </div>
    {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        La papelera de reciclaje est√° vac√≠a.
    </div>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('seleccion_anio') }}" class="btn btn-secondary">‚Üê Volver a Selecci√≥n de A√±o</a>
</div>
{% endblock %}